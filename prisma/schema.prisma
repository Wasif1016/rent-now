// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Seed configuration
// Run with: bun run db:seed

datasource db {
  provider = "postgresql"
  // Note: In Prisma 7, url is configured in prisma.config.ts, not here
}

// ============================================
// ENUMS
// ============================================

enum VendorVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum InquiryStatus {
  PENDING
  CONTACTED
  CLOSED
}

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
  CNG
}

enum Transmission {
  MANUAL
  AUTOMATIC
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum VehicleStatus {
  DRAFT
  PUBLISHED
}

enum RegistrationStatus {
  NOT_REGISTERED
  ACCOUNT_CREATED
  EMAIL_SENT
  ACTIVE
  SUSPENDED
}

// ============================================
// MODELS
// ============================================

model Country {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique
  code      String    @unique // ISO country code (e.g., "PK" for Pakistan)
  isActive  Boolean?  @default(true)
  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now()) @updatedAt

  // Relations
  cities City[]
}

model City {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique
  province  String? // Optional: keep for backward compatibility
  countryId String
  isActive  Boolean?  @default(true)
  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now()) @updatedAt

  // Relations
  country          Country           @relation(fields: [countryId], references: [id])
  towns            Town[]
  vehicles         Vehicle[]
  routesFrom       Route[]           @relation("RouteFromCity")
  routesTo         Route[]           @relation("RouteToCity")
  pickupBookings   Booking[]         @relation("BookingPickupCity")
  dropoffBookings  Booking[]         @relation("BookingDropoffCity")
  seoCityOverrides SeoCityOverride[]
}

model Town {
  id        String    @id @default(uuid())
  name      String
  slug      String
  cityId    String
  isActive  Boolean?  @default(true)
  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now()) @updatedAt

  // Relations
  city     City      @relation(fields: [cityId], references: [id], onDelete: Cascade)
  vehicles Vehicle[]

  @@unique([slug, cityId])
  @@index([cityId])
  @@index([slug])
}

model VehicleType {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  icon        String? // Optional icon URL
  description String? // Optional description
  isActive    Boolean?  @default(true)
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @default(now()) @updatedAt

  // Relations
  vehicles Vehicle[]
}

model VehicleBrand {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique
  logo      String? // Cloudinary URL
  isActive  Boolean?  @default(true)
  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now()) @updatedAt

  // Relations
  vehicleModels VehicleModel[]
}

model VehicleModel {
  id                  String        @id @default(uuid())
  name                String
  slug                String
  vehicleBrandId      String
  capacity            Int? // Passenger capacity
  image               String? // Predefined vehicle image path
  bodyType            String? // HatchBack, Sedan, SUV, Van
  doors               Int? // Number of doors
  largeBags           Int? // Number of large bags
  defaultColor        String? // Default color (usually White)
  defaultTransmission Transmission? // Default transmission
  isPredefined        Boolean?      @default(false) // Mark as predefined vehicle
  isActive            Boolean?      @default(true)
  createdAt           DateTime?     @default(now())
  updatedAt           DateTime?     @default(now()) @updatedAt

  // Relations
  vehicleBrand VehicleBrand @relation(fields: [vehicleBrandId], references: [id])
  vehicles     Vehicle[]

  @@unique([slug, vehicleBrandId])
  @@index([vehicleBrandId])
  @@index([isPredefined])
}

model Vendor {
  id                         String                    @id @default(uuid())
  name                       String
  slug                       String                    @unique
  email                      String?                   @unique
  phone                      String?
  personName                 String? // Contact person name (admin-only)
  whatsappPhone              String? // WhatsApp number for bookings (admin-only)
  address                    String?
  supabaseUserId             String?                   @unique // For Supabase auth integration
  description                String? // Vendor bio
  logo                       String? // Cloudinary URL
  verificationStatus         VendorVerificationStatus? @default(PENDING)
  verifiedAt                 DateTime?
  isActive                   Boolean?                  @default(true)
  images                     Json? // Additional images (array of Cloudinary URLs)
  documents                  Json? // Verification documents
  metadata                   Json? // Additional metadata
  // Admin onboarding fields
  registrationStatus         RegistrationStatus?       @default(NOT_REGISTERED)
  temporaryPasswordEncrypted String? // Encrypted temporary password (admin-only)
  emailSentAt                DateTime? // When credentials email was sent
  accountCreatedAt           DateTime? // When account was created
  town                       String? // From CSV import
  province                   String? // From CSV import (keep for compatibility)
  googleMapsUrl              String? // From CSV import
  createdAt                  DateTime?                 @default(now())
  updatedAt                  DateTime?                 @default(now()) @updatedAt

  // Relations
  vehicles  Vehicle[]
  inquiries Inquiry[]
  bookings  Booking[]
  routes    Route[]
}

model Vehicle {
  id              String        @id @default(uuid())
  vendorId        String
  vehicleModelId  String?
  vehicleTypeId   String? // Optional: vehicle type (Cars, Hiace, Vans, etc.)
  cityId          String // Required: vehicle location (city)
  townId          String? // Optional: specific town within city
  title           String // Display title
  slug            String        @unique // For SEO URLs
  description     String? // Full description
  year            Int? // Manufacturing year
  mileage         Int? // KM driven
  fuelType        FuelType?
  transmission    Transmission?
  features        Json? // Array of features (AC, GPS, Bluetooth, etc.)
  color           String?
  seats           Int? // Number of seats
  images          Json? // Array of Cloudinary URLs
  views           Int           @default(0) // View counter for analytics
  featured        Boolean       @default(false) // Premium listing flag
  isAvailable     Boolean?      @default(true)
  isVerified      Boolean?      @default(false)
  status          VehicleStatus @default(PUBLISHED)
  // Pricing fields (optional)
  priceWithDriver Int? // Price per day with driver
  priceSelfDrive  Int? // Price per day self-drive
  priceWithinCity Int? // Price for within city
  priceOutOfCity  Int? // Price for out of city
  metadata        Json? // Additional metadata
  createdAt       DateTime?     @default(now())
  updatedAt       DateTime?     @default(now()) @updatedAt

  // Relations
  vendor       Vendor        @relation(fields: [vendorId], references: [id])
  vehicleModel VehicleModel? @relation(fields: [vehicleModelId], references: [id])
  vehicleType  VehicleType?  @relation(fields: [vehicleTypeId], references: [id])
  city         City          @relation(fields: [cityId], references: [id])
  town         Town?         @relation(fields: [townId], references: [id])
  inquiries    Inquiry[]
  bookings     Booking[]
  routes       Route[]

  @@index([cityId])
  @@index([townId])
  @@index([cityId, townId])
  @@index([isAvailable])
  @@index([vehicleTypeId])
}

model Inquiry {
  id        String         @id @default(uuid())
  vehicleId String
  vendorId  String
  userName  String
  userPhone String
  userEmail String?
  message   String? // Inquiry message
  status    InquiryStatus? @default(PENDING)
  createdAt DateTime?      @default(now())
  updatedAt DateTime?      @default(now()) @updatedAt

  // Relations
  vehicle Vehicle @relation(fields: [vehicleId], references: [id])
  vendor  Vendor  @relation(fields: [vendorId], references: [id])

  @@index([vehicleId])
  @@index([vendorId])
  @@index([status])
}

model Booking {
  id                  String        @id @default(uuid())
  vehicleId           String
  vendorId            String
  userName            String
  userPhone           String
  userEmail           String?
  bookingDate         DateTime? // Legacy requested booking date (keep for backward compatibility)
  message             String? // Additional message from user
  status              BookingStatus @default(PENDING)
  totalAmount         Int? // Total booking amount
  commissionAmount    Int? // Platform commission amount (currently 2% of totalAmount)
  // New fields to support route-based & city-based bookings and advance payments
  pickupCityId        String? // City where the booking starts
  dropoffCityId       String? // City where the booking ends (for intercity/route bookings)
  routeId             String? // Optional associated route
  startDateTime       DateTime? // Trip start date & time
  endDateTime         DateTime? // Trip end date & time
  advanceAmount       Int? // 2% advance amount paid online
  whatsappMessageSent Boolean       @default(false)
  createdAt           DateTime?     @default(now())
  updatedAt           DateTime?     @default(now()) @updatedAt

  // Relations
  vehicle     Vehicle @relation(fields: [vehicleId], references: [id])
  vendor      Vendor  @relation(fields: [vendorId], references: [id])
  pickupCity  City?   @relation("BookingPickupCity", fields: [pickupCityId], references: [id])
  dropoffCity City?   @relation("BookingDropoffCity", fields: [dropoffCityId], references: [id])
  route       Route?  @relation(fields: [routeId], references: [id])

  @@index([vehicleId])
  @@index([vendorId])
  @@index([status])
  @@index([createdAt])
}

/// ============================================
/// SEO & Content Models
/// ============================================

model FaqGroup {
  id        String    @id @default(uuid())
  name      String
  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now()) @updatedAt

  // Relations
  faqs          Faq[]
  seoDimensions SeoDimension[]
}

model Faq {
  id         String    @id @default(uuid())
  faqGroupId String
  question   String
  answer     String
  sortOrder  Int?      @default(0)
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @default(now()) @updatedAt

  // Relations
  faqGroup FaqGroup @relation(fields: [faqGroupId], references: [id])

  @@index([faqGroupId])
}

model SeoDimension {
  id                             String    @id @default(uuid())
  slug                           String
  type                           String // e.g. "keyword", "vehicle_type", "capacity", "fuel_type", "event_type"
  basePattern                    String // e.g. "/rent-a-car/{city}"
  defaultH1Template              String
  defaultTitleTemplate           String
  defaultMetaDescriptionTemplate String
  faqGroupId                     String?
  isIndexableByDefault           Boolean   @default(true)
  createdAt                      DateTime? @default(now())
  updatedAt                      DateTime? @default(now()) @updatedAt

  // Relations
  faqGroup      FaqGroup?         @relation(fields: [faqGroupId], references: [id])
  cityOverrides SeoCityOverride[]

  @@unique([slug, type])
  @@index([type])
}

model SeoCityOverride {
  id                      String    @id @default(uuid())
  cityId                  String
  seoDimensionId          String
  h1Template              String?
  titleTemplate           String?
  metaDescriptionTemplate String?
  isIndexable             Boolean?
  createdAt               DateTime? @default(now())
  updatedAt               DateTime? @default(now()) @updatedAt

  // Relations
  city         City         @relation(fields: [cityId], references: [id])
  seoDimension SeoDimension @relation(fields: [seoDimensionId], references: [id])

  @@unique([cityId, seoDimensionId])
  @@index([cityId])
  @@index([seoDimensionId])
}

model Route {
  id                  String    @id @default(uuid())
  vendorId            String
  fromCityId          String
  toCityId            String
  vehicleId           String
  basePrice           Int // Base price in Rs.
  instantAvailability Boolean   @default(true)
  compatibleBodyTypes Json? // Array of compatible body types
  isActive            Boolean   @default(true)
  createdAt           DateTime? @default(now())
  updatedAt           DateTime? @default(now()) @updatedAt

  // Relations
  vendor   Vendor    @relation(fields: [vendorId], references: [id])
  fromCity City      @relation("RouteFromCity", fields: [fromCityId], references: [id])
  toCity   City      @relation("RouteToCity", fields: [toCityId], references: [id])
  vehicle  Vehicle   @relation(fields: [vehicleId], references: [id])
  bookings Booking[]

  @@index([vendorId])
  @@index([fromCityId])
  @@index([toCityId])
  @@index([vehicleId])
  @@index([isActive])
}

model ActivityLog {
  id          String   @id @default(uuid())
  action      String // e.g., "ACCOUNT_CREATED", "EMAIL_SENT", "PASSWORD_RESET"
  entityType  String // e.g., "VENDOR", "VEHICLE", "ROUTE"
  entityId    String
  adminUserId String? // Supabase user ID of admin who performed action
  details     Json? // Additional context (never store plaintext passwords)
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([adminUserId])
  @@index([createdAt])
  @@index([action])
}

model EmailTemplate {
  id        String   @id @default(uuid())
  name      String   @unique // e.g., "vendor_credentials"
  subject   String
  body      String // HTML template with {{variables}}
  variables Json? // Array of available variables
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
